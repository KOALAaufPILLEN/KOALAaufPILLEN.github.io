<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#f7f2ff">
  <title>Luvvies Crush 2.0: Ultimate Edition</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ------------------------------------------------------------------
       1. CORE VARIABLES & THEMES
       ------------------------------------------------------------------ */
    :root {
      /* LIGHT THEME (Default) */
      --bg-grad-start: #f7f2ff;
      --bg-grad-end: #eaf6ff;
      --card-bg: rgba(255, 255, 255, 0.85);
      --card-border: rgba(255, 255, 255, 0.6);
      --text-main: #1d1334;
      --text-sub: #5a4b75;
      --shadow-soft: 0 18px 40px rgba(20, 10, 60, 0.08);
      --shadow-deep: 0 25px 80px rgba(20, 10, 60, 0.15);
      --stroke: rgba(17, 13, 26, 0.08);
      
      --board-bg-grad: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.4));
      --board-shadow: 0 20px 60px rgba(10,0,30,0.1), inset 0 0 40px rgba(255,255,255,0.8);

      /* ACCENTS */
      --accent-pink: #ff4fb9;
      --accent-blue: #7ad8ff;
      --accent-gold: #ffcf5a;
      --accent-purple: #8b5cf6;

      /* GRID CONFIG */
      --cols: 9;
      --rows: 9;
      --cell: 56px;
      --gap: 8px;
      --pad: 16px;
      --board-radius: 32px;

      /* ANIMATION TIMINGS */
      --anim-swap: 280ms;
      --anim-fall: 400ms;
      --anim-pop: 350ms;
      --toast-dur: 3200ms;
    }

    /* DARK MODE OVERRIDES */
    :root.dark-mode {
      --bg-grad-start: #0f0b1e;
      --bg-grad-end: #1b142d;
      --card-bg: rgba(30, 25, 50, 0.88);
      --card-border: rgba(255, 255, 255, 0.12);
      --text-main: #f0e6ff;
      --text-sub: #a89bbd;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.4);
      --shadow-deep: 0 30px 90px rgba(0, 0, 0, 0.6);
      --stroke: rgba(255, 255, 255, 0.1);

      --board-bg-grad: radial-gradient(circle at 30% 30%, rgba(40,30,60,0.9), rgba(20,15,40,0.95));
      --board-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 0 40px rgba(0,0,0,0.4);
    }

    /* ------------------------------------------------------------------
       2. GLOBAL RESET & LAYOUT
       ------------------------------------------------------------------ */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; width: 100%; }

    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: var(--text-main);
      background: linear-gradient(180deg, var(--bg-grad-start), var(--bg-grad-end));
      overflow: hidden;
      transition: background 0.5s ease, color 0.5s ease;
      user-select: none;
    }

    /* Background Animation Layer */
    #bg-layer {
      position: absolute; inset: 0; z-index: 0; pointer-events: none;
      background: 
        radial-gradient(circle at 15% 15%, rgba(255, 79, 185, 0.08), transparent 40%),
        radial-gradient(circle at 85% 85%, rgba(122, 216, 255, 0.1), transparent 40%),
        radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.05), transparent 60%);
      filter: blur(40px);
      animation: ambientPulse 10s ease-in-out infinite alternate;
    }
    @keyframes ambientPulse { 0% { opacity: 0.6; transform: scale(1); } 100% { opacity: 1; transform: scale(1.1); } }

    /* Partikel Layer (Global) */
    #global-fx { position: absolute; inset: 0; z-index: 1; pointer-events: none; overflow: hidden; }

    /* Main App Container */
    #app {
      position: relative; z-index: 10;
      width: min(1000px, 96vw);
      height: 100%;
      margin: 0 auto;
      display: flex; flex-direction: column;
      padding: 10px 0 20px;
    }

    /* Scrollable Content Area */
    #scroll-wrap {
      flex: 1; overflow-y: auto; overflow-x: hidden;
      padding: 10px;
      scrollbar-width: none;
      display: flex; flex-direction: column; gap: 16px;
    }
    #scroll-wrap::-webkit-scrollbar { display: none; }

    /* ------------------------------------------------------------------
       3. UI COMPONENTS: CARDS, BUTTONS, STATS
       ------------------------------------------------------------------ */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      padding: 16px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-deep); }

    /* Header / Top Bar */
    .top-bar {
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
    }

    /* Difficulty Pills */
    .diff-switch {
      display: flex; gap: 6px; padding: 5px;
      background: rgba(255,255,255,0.4);
      border-radius: 99px;
      border: 1px solid var(--stroke);
    }
    .dark-mode .diff-switch { background: rgba(0,0,0,0.3); }
    
    .diff-opt {
      padding: 8px 16px; border-radius: 99px;
      font-weight: 800; font-size: 13px; cursor: pointer;
      opacity: 0.7; transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .diff-opt.active {
      background: linear-gradient(135deg, var(--accent-pink), var(--accent-blue));
      color: white; opacity: 1;
      box-shadow: 0 4px 12px rgba(255, 79, 185, 0.4);
      transform: scale(1.05);
    }

    /* Action Buttons */
    .btn-group { display: flex; gap: 10px; }
    
    .btn {
      position: relative; height: 44px; padding: 0 20px;
      border: none; border-radius: 99px;
      font-weight: 800; font-size: 14px; color: white;
      cursor: pointer; overflow: hidden;
      background: var(--accent-purple);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3), inset 0 2px 0 rgba(255,255,255,0.2);
      transition: all 0.2s ease;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .btn:active { transform: scale(0.96); }
    
    .btn.secondary { background: linear-gradient(135deg, var(--accent-pink), #ff9adf); box-shadow: 0 4px 15px rgba(255, 79, 185, 0.4); }
    .btn.ghost { background: transparent; border: 2px solid var(--stroke); color: var(--text-main); box-shadow: none; }
    .dark-mode .btn.ghost { border-color: rgba(255,255,255,0.3); color: white; }

    /* Stats Grid */
    .stats-row {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
    }
    .stat-box {
      background: var(--card-bg); border-radius: 18px; padding: 10px;
      text-align: center; border: 1px solid var(--stroke);
      display: flex; flex-direction: column; justify-content: center;
    }
    .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; font-weight: 700; }
    .stat-val { font-size: 20px; font-weight: 900; margin-top: 4px; color: var(--text-main); }
    .stat-val.highlight { color: var(--accent-pink); }

    /* Progress Bar */
    .prog-wrap {
      height: 12px; background: rgba(0,0,0,0.05); border-radius: 99px; overflow: hidden;
      margin-top: 8px; position: relative;
    }
    .dark-mode .prog-wrap { background: rgba(255,255,255,0.1); }
    .prog-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--accent-pink), var(--accent-gold), var(--accent-blue));
      background-size: 200% 100%;
      animation: gradientMove 3s linear infinite;
      transition: width 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

    /* ------------------------------------------------------------------
       4. THE GAME BOARD (CENTERPIECE)
       ------------------------------------------------------------------ */
    .board-container {
      position: relative;
      margin: 10px auto;
      padding: var(--pad);
      background: var(--board-bg-grad);
      border-radius: var(--board-radius);
      box-shadow: var(--board-shadow);
      border: 1px solid rgba(255,255,255,0.4);
      width: fit-content;
      user-select: none;
      touch-action: none; /* Wichtig fÃ¼r Mobile Drag */
    }
    .dark-mode .board-container { border: 1px solid rgba(255,255,255,0.1); }

    #grid {
      position: relative;
      display: grid;
      grid-template-columns: repeat(var(--cols), var(--cell));
      grid-template-rows: repeat(var(--rows), var(--cell));
      gap: var(--gap);
    }

    /* Grid Cells (Hintergrund-Slots) */
    .slot {
      width: var(--cell); height: var(--cell);
      background: rgba(0,0,0,0.03);
      border-radius: 14px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .dark-mode .slot { background: rgba(255,255,255,0.05); }

    /* ------------------------------------------------------------------
       5. TILES & CHARACTERS (THE SOUL)
       ------------------------------------------------------------------ */
    .tile {
      position: absolute;
      width: var(--cell); height: var(--cell);
      left: 0; top: 0;
      transform: translate(calc(var(--c) * (var(--cell) + var(--gap))), calc(var(--r) * (var(--cell) + var(--gap))));
      z-index: 10;
      transition: transform var(--anim-swap) cubic-bezier(0.2, 1.2, 0.5, 1);
      cursor: pointer;
      will-change: transform;
    }
    
    /* Interactive States */
    .tile.selected .inner { transform: scale(0.9); box-shadow: 0 0 0 3px var(--accent-pink); animation: pulse 1s infinite; }
    .tile.hint .inner { animation: shake 2s ease-in-out infinite; box-shadow: 0 0 15px var(--accent-gold); }
    .tile.matched .inner { animation: popOut var(--anim-pop) forwards; }
    .tile.dropping { transition: transform var(--anim-fall) cubic-bezier(0.5, 0, 0.5, 1.2); z-index: 20; }
    .tile.spawn { animation: spawnIn 0.4s back.out; }

    /* The Inner Plate (Visuals) */
    .inner {
      width: 100%; height: 100%;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.1)), var(--tile-color);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15), inset 0 -4px 8px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.5);
      display: flex; align-items: center; justify-content: center;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s;
    }
    
    /* Hardcore Matching Visuals (Pattern Overlay if needed, currently color) */
    .inner::after {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 50%);
      pointer-events: none;
    }

    /* Images */
    .tile-img {
      width: 85%; height: 85%;
      object-fit: contain;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2));
      pointer-events: none;
      z-index: 2;
    }

    /* ------------------------------------------------------------------
       6. SPECIALS: BOSSES, EVOLUTIONS & EFFECTS
       ------------------------------------------------------------------ */
    
    /* Fledernuss Evolution Stages */
    .tile[data-type="fleder"] .inner { border: 2px solid transparent; }
    .tile[data-type="fleder"][data-evo="2"] .inner { border-color: #a35eff; box-shadow: 0 0 10px #a35eff; }
    .tile[data-type="fleder"][data-evo="3"] .inner { border-color: #ff0055; box-shadow: 0 0 20px #ff0055; animation: bossPulse 1s infinite; }

    /* Boss: MellowZilla (3x3) */
    .boss-overlay {
      position: absolute;
      width: calc(3 * var(--cell) + 2 * var(--gap));
      height: calc(3 * var(--cell) + 2 * var(--gap));
      background: linear-gradient(135deg, #2b1b4f, #4a3b75);
      border-radius: 24px;
      z-index: 50;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      border: 4px solid var(--accent-pink);
      animation: zillaFloat 3s ease-in-out infinite;
      transition: transform 0.3s;
    }
    .boss-overlay.hit { animation: zillaHit 0.4s; }
    .boss-hp-bar {
      width: 80%; height: 8px; background: #000; border-radius: 4px; margin-top: 10px; overflow: hidden;
    }
    .boss-hp-fill { width: 100%; height: 100%; background: #ff0055; transition: width 0.2s; }
    .boss-img { width: 70%; filter: drop-shadow(0 0 10px rgba(255,79,185,0.5)); }

    /* Animations */
    @keyframes pulse { 0% { transform: scale(0.95); } 50% { transform: scale(1.05); } 100% { transform: scale(0.95); } }
    @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
    @keyframes popOut { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.8; } 100% { transform: scale(0); opacity: 0; } }
    @keyframes spawnIn { 0% { transform: scale(0); } 70% { transform: scale(1.1); } 100% { transform: scale(1); } }
    @keyframes zillaFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes zillaHit { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(0.95); filter: brightness(2) sepia(1) hue-rotate(-50deg); } 100% { transform: scale(1); filter: brightness(1); } }

    /* ------------------------------------------------------------------
       7. MODALS, TOASTS & EXTRAS
       ------------------------------------------------------------------ */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
      z-index: 100; display: none; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 0.3s;
    }
    .modal-backdrop.active { display: flex; opacity: 1; }
    .modal {
      background: var(--card-bg); width: min(500px, 90vw); padding: 30px;
      border-radius: 30px; border: 1px solid var(--card-border);
      box-shadow: 0 40px 100px rgba(0,0,0,0.5);
      text-align: center; transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-backdrop.active .modal { transform: scale(1); }
    .modal h2 { margin: 0 0 10px; font-size: 28px; background: linear-gradient(45deg, var(--accent-pink), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast {
      background: rgba(255,255,255,0.95); padding: 12px 20px; border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-left: 4px solid var(--accent-pink);
      transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex; align-items: center; gap: 10px; pointer-events: auto; font-weight: 600;
    }
    .dark-mode .toast { background: #2b1b4f; color: white; }
    .toast.show { transform: translateX(0); }
    .toast img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }

    /* Responsive Adjustments */
    @media (max-width: 600px) {
      :root { --cell: 42px; --gap: 6px; }
      .stats-row { grid-template-columns: repeat(3, 1fr); }
      .stat-box:nth-child(4), .stat-box:nth-child(5) { display: none; } /* Hide less important stats on tiny screens */
      .top-bar { justify-content: center; }
    }
  </style>
</head>
<body>

  <div id="bg-layer"></div>
  <div id="global-fx"></div>

  <div id="app">
    
    <div class="card top-bar">
      <div class="diff-switch" id="diff-switch">
        <div class="diff-opt" data-diff="easy">Easy</div>
        <div class="diff-opt active" data-diff="normal">Normal</div>
        <div class="diff-opt" data-diff="shock">Schock</div>
      </div>
      
      <div class="btn-group">
        <button class="btn ghost" id="btn-darkmode">ðŸŒ™</button>
        <button class="btn ghost" id="btn-sound">ðŸ”Š</button>
        <button class="btn secondary" id="btn-new">Neu</button>
        <button class="btn" id="btn-hint">Hint (-2)</button>
      </div>
    </div>

    <div id="scroll-wrap">
      
      <div class="stats-row">
        <div class="stat-box">
          <span class="stat-label">Level</span>
          <span class="stat-val" id="ui-lvl">1</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Score</span>
          <span class="stat-val highlight" id="ui-score">0</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Ziel</span>
          <span class="stat-val" id="ui-target">2500</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Moves</span>
          <span class="stat-val" id="ui-moves">25</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">Combo</span>
          <span class="stat-val" id="ui-combo">x1</span>
        </div>
      </div>

      <div class="prog-wrap">
        <div class="prog-fill" id="ui-prog"></div>
      </div>

      <div class="board-container">
        <div id="grid">
          </div>
        <div id="boss-layer"></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0; color:var(--text-sub);">Deine Luvvies Crew</h3>
        <div style="font-size: 13px; line-height: 1.6; opacity: 0.8;" id="lore-text">
          Tippe auf ein Luvvie, um mehr zu erfahren.
        </div>
      </div>

    </div> </div> <div id="toast-container"></div>

  <div class="modal-backdrop" id="modal-start">
    <div class="modal">
      <h2>Luvvies Crush 2.0</h2>
      <p><b>Hardcore Edition:</b> Figur + Farbe mÃ¼ssen stimmen!</p>
      <p>Ab Level 4: Simba & Smokey Bond.<br>Ab Level 10: Fledernuss Evolution.<br>Level 20: MellowZilla Boss Fight.</p>
      <input type="text" id="player-name" placeholder="Dein Name (z.B. KOALAaufPILLEN)" style="padding:10px; border-radius:8px; border:1px solid #ccc; width:80%; margin:15px 0; text-align:center;">
      <br>
      <button class="btn secondary" style="font-size:18px; padding:10px 40px;" onclick="Game.start()">Let's Go!</button>
    </div>
  </div>

  <div class="modal-backdrop" id="modal-gameover">
    <div class="modal">
      <h2 style="font-size:40px;">GAME OVER ðŸ’€</h2>
      <p style="font-size:20px;">Score: <span id="go-score">0</span></p>
      <p id="go-msg">Knapp vorbei ist auch daneben.</p>
      <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
        <button class="btn ghost" onclick="Game.init()">Revanche</button>
        <button class="btn secondary" onclick="Game.postScore()">Score Posten</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * ------------------------------------------------------------------
     * LUVVIES CRUSH 2.0 - ULTIMATE EDITION ENGINE
     * ------------------------------------------------------------------
     * Ein Monolith aus purer Liebe zum Detail.
     */

    // --- CONFIG & ASSETS ---
    const ASSETS = {
      sweety:   "https://static.wixstatic.com/media/d05122_efe39fec7e5c4d569dfb3fef75e5b6ff~mv2.png",
      sleepy:   "https://static.wixstatic.com/media/d05122_cfd779a0aad04c72bd08efbc0f363f53~mv2.png",
      joyce:    "https://static.wixstatic.com/media/d05122_36a3f8d83be4433082995ee1a8003218~mv2.png",
      smokey:   "https://static.wixstatic.com/media/d05122_9a607ff042b647b789e3b44cc75bd38d~mv2.png",
      simba:    "https://static.wixstatic.com/media/d05122_4d92be50d61e4a2297af16a3295c38bf~mv2.png",
      fleder:   "https://static.wixstatic.com/media/d05122_1950f2496b344e56bcac10ea51286750~mv2.png", // Placeholder visuals managed via CSS filter
      mellow:   "https://static.wixstatic.com/media/d05122_53fbcb0babf447a5a32cc3b3fbecad2b~mv2.png",
      koala:    "https://static.wixstatic.com/media/d05122_9cb17e901a1a4775819bfda895d0f1c9~mv2.png",
      citrussy: "https://static.wixstatic.com/media/d05122_9cdc763a1ec94a90a3fd91ee3481b2c4~mv2.png"
    };

    const CHAR_DATA = {
      sweety: { name: "Sweety", color: "#ff4fb9", quotes: ["Zucker!", "So sweet!", "Yummy!"] },
      sleepy: { name: "Sleepy", color: "#7ad8ff", quotes: ["GÃ¤hn...", "Noch 5 Minuten...", "Zzz..."] },
      joyce:  { name: "Joyce",  color: "#b8b1ff", quotes: ["Wuff!", "Bin dabei!", "Leckerli?"] },
      smokey: { name: "Smokey", color: "#ffcf5a", quotes: ["Miau.", "Ich bin Boss.", "Schnurrr..."] },
      simba:  { name: "Simba",  color: "#ff9d3c", quotes: ["Roar!", "BeschÃ¼tzer!", "Kuscheln?"] },
      fleder: { name: "Fledernuss", color: "#a35eff", quotes: ["Flattern!", "Nachtaktiv!", "Echolot!"] }
    };

    const DIFFICULTY = {
      easy:   { moves: 35, colors: 3, targetBase: 2000, hintCost: 1 },
      normal: { moves: 25, colors: 4, targetBase: 3500, hintCost: 2 },
      shock:  { moves: 15, colors: 5, targetBase: 6000, hintCost: 3 }
    };

    // --- HELPER: SOUND MANAGER (Placeholder for Audio Logic) ---
    const AudioMan = {
      play(type) {
        // Hier kÃ¶nnten echte Sounds via AudioContext abgespielt werden
        // FÃ¼r diese Version simulieren wir nur den "Intent"
        // console.log("Sound:", type); 
      }
    };

    // --- HELPER: PARTICLE SYSTEM ---
    const FX = {
      container: document.getElementById('global-fx'),
      spawn(x, y, color, count = 8) {
        for(let i=0; i<count; i++) {
          const el = document.createElement('div');
          const size = Math.random() * 8 + 4;
          const angle = Math.random() * Math.PI * 2;
          const velocity = Math.random() * 60 + 20;
          
          el.style.cssText = `
            position: absolute; left: ${x}px; top: ${y}px;
            width: ${size}px; height: ${size}px;
            background: ${color}; border-radius: 50%;
            pointer-events: none; z-index: 99;
            box-shadow: 0 0 10px ${color};
          `;
          this.container.appendChild(el);

          // Animate via WAAPI
          const anim = el.animate([
            { transform: 'translate(0,0) scale(1)', opacity: 1 },
            { transform: `translate(${Math.cos(angle)*velocity}px, ${Math.sin(angle)*velocity + 50}px) scale(0)`, opacity: 0 }
          ], { duration: 600 + Math.random()*200, easing: 'cubic-bezier(0,0,0.2,1)' });

          anim.onfinish = () => el.remove();
        }
      },
      textFloat(x, y, text, color="#fff") {
        const el = document.createElement('div');
        el.textContent = text;
        el.style.cssText = `
          position:absolute; left:${x}px; top:${y}px;
          color:${color}; font-weight:900; font-size:20px;
          text-shadow:0 2px 4px rgba(0,0,0,0.5); pointer-events:none; z-index:100;
        `;
        this.container.appendChild(el);
        const anim = el.animate([
          { transform: 'translate(-50%, 0) scale(1)', opacity: 1 },
          { transform: 'translate(-50%, -60px) scale(1.2)', opacity: 0 }
        ], { duration: 800 });
        anim.onfinish = () => el.remove();
      }
    };

    // --- GAME LOGIC ---
    const Game = {
      grid: [],
      rows: 9, cols: 9,
      tiles: new Map(), // id -> DOM Element
      state: 'IDLE', // IDLE, ANIMATING, SWAPPING, BOSS
      stats: { score: 0, level: 1, moves: 0, combo: 0 },
      settings: { diff: 'normal', sound: true },
      selection: null,
      boss: null, // { hp, maxHp, active }
      
      // Init
      init() {
        // Reset Stats
        this.stats = { score: 0, level: 1, moves: DIFFICULTY[this.settings.diff].moves, combo: 1 };
        this.boss = null;
        document.getElementById('boss-layer').innerHTML = '';
        
        // Setup Grid
        this.setupLevel();
        this.updateUI();
        
        // Modals
        document.querySelector('.modal-backdrop.active')?.classList.remove('active');
      },

      start() {
        const name = document.getElementById('player-name').value.trim();
        // Whitelist Check
        const safeName = name.replace(/[^a-zA-Z0-9 ]/g, "");
        const whitelist = ["KOALAaufPILLEN"];
        const blacklist = ["arsch", "idiot"];
        
        if (blacklist.some(b => safeName.toLowerCase().includes(b)) && !whitelist.includes(name)) {
          alert("Naughty Luvvie! WÃ¤hle einen anderen Namen.");
          return;
        }
        
        this.playerName = name || "Gast";
        document.getElementById('modal-start').classList.remove('active');
        this.init();
      },

      setupLevel() {
        const board = document.getElementById('grid');
        board.innerHTML = '';
        this.grid = [];
        this.tiles.clear();

        // Slots erstellen
        for(let r=0; r<this.rows; r++) {
          this.grid[r] = [];
          for(let c=0; c<this.cols; c++) {
            const slot = document.createElement('div');
            slot.className = 'slot';
            board.appendChild(slot);
            
            // Initial Tile Logic
            let tileType;
            do {
              tileType = this.randomTileType();
            } while (this.wouldMatch(r, c, tileType));
            
            this.createTile(r, c, tileType);
          }
        }
        
        // Level Specifics
        if (this.stats.level % 20 === 0) this.spawnBoss();
      },

      randomTileType() {
        const pool = ['sweety', 'sleepy', 'joyce', 'smokey'];
        if (this.stats.level >= 4) pool.push('simba');
        if (this.stats.level >= 10) pool.push('fleder');
        
        const type = pool[Math.floor(Math.random() * pool.length)];
        
        // HARDCORE COLOR LOGIC: Every char has 2 possible colors variants
        const colors = ["#ff9adf", "#7ad8ff", "#ffcf5a", "#b8ffb1"]; 
        const maxCol = DIFFICULTY[this.settings.diff].colors;
        const color = colors[Math.floor(Math.random() * maxCol)];
        
        return { type, color, id: Math.random().toString(36).substr(2), evo: 1 };
      },

      createTile(r, c, data) {
        const el = document.createElement('div');
        el.className = 'tile spawn';
        el.dataset.id = data.id;
        el.dataset.type = data.type;
        el.dataset.evo = data.evo;
        el.style.setProperty('--r', r);
        el.style.setProperty('--c', c);
        el.style.setProperty('--tile-color', data.color);

        const imgUrl = ASSETS[data.type];
        el.innerHTML = `<div class="inner"><img src="${imgUrl}" class="tile-img"></div>`;
        
        el.onclick = () => this.handleTileClick(r, c);
        
        document.getElementById('grid').appendChild(el);
        this.grid[r][c] = { ...data, r, c };
        this.tiles.set(data.id, el);
        
        setTimeout(() => el.classList.remove('spawn'), 400);
      },

      // --- CORE INTERACTION ---
      handleTileClick(r, c) {
        if (this.state !== 'IDLE') return;
        const clicked = this.grid[r][c];
        if (!clicked) return;

        if (!this.selection) {
          // Select
          this.selection = clicked;
          this.tiles.get(clicked.id).classList.add('selected');
          AudioMan.play('select');
        } else {
          // Action
          const first = this.selection;
          this.tiles.get(first.id).classList.remove('selected');
          this.selection = null;

          if (first.id === clicked.id) return; // Deselect

          const dist = Math.abs(first.r - r) + Math.abs(first.c - c);
          if (dist === 1) {
            this.attemptSwap(first, clicked);
          } else {
            // New selection
            this.selection = clicked;
            this.tiles.get(clicked.id).classList.add('selected');
            AudioMan.play('select');
          }
        }
      },

      async attemptSwap(t1, t2) {
        this.state = 'SWAPPING';
        
        // UI Swap
        await this.visualSwap(t1, t2);
        
        // Logical Swap
        this.grid[t1.r][t1.c] = t2;
        this.grid[t2.r][t2.c] = t1;
        [t1.r, t1.c, t2.r, t2.c] = [t2.r, t2.c, t1.r, t1.c];

        // Check Match
        const matches = this.findMatches();
        
        // BOSS MOVEMENT PENALTY Check
        if (this.boss && this.boss.active) {
            // Chance that boss moves tiles around on bad swap?
        }

        if (matches.length > 0) {
          this.stats.moves--;
          this.stats.combo = 1;
          await this.processMatches(matches);
        } else {
          // Invalid Swap -> Swap Back
          AudioMan.play('bad_swap');
          
          // PENALTY: Cost moves for bad hint? No, just bad swap penalty if Shock mode
          if (this.settings.diff === 'shock') {
             this.stats.moves -= 3;
             this.showToast("Zuckerschock!", "-3 Moves Strafe", ASSETS.grumpy);
          }

          await this.visualSwap(t1, t2);
          // Revert Logic
          this.grid[t1.r][t1.c] = t2;
          this.grid[t2.r][t2.c] = t1;
          [t1.r, t1.c, t2.r, t2.c] = [t2.r, t2.c, t1.r, t1.c];
          
          this.state = 'IDLE';
        }
        this.updateUI();
      },

      visualSwap(t1, t2) {
        const el1 = this.tiles.get(t1.id);
        const el2 = this.tiles.get(t2.id);
        el1.style.setProperty('--r', t1.r);
        el1.style.setProperty('--c', t1.c);
        el2.style.setProperty('--r', t2.r);
        el2.style.setProperty('--c', t2.c);
        return new Promise(r => setTimeout(r, 280));
      },

      // --- MATCH LOGIC (HARDCORE) ---
      wouldMatch(r, c, typeObj) {
        // Pre-check for generation
        // Requires checking type AND color
        if (c >= 2) {
           const a = this.grid[r][c-1] || {}; // Mock during generation if grid array exists
           const b = this.grid[r][c-2] || {};
           // Note: During init grid might be partial, logic simplified here for brevity
        }
        return false; 
      },

      findMatches() {
        let matchedSet = new Set();
        
        // Helper: Strict Compare
        const isMatch = (a, b) => a && b && a.type === b.type && a.color === b.color;

        // Horizontal
        for(let r=0; r<this.rows; r++) {
          for(let c=0; c<this.cols-2; c++) {
            let t = this.grid[r][c];
            if(!t) continue;
            let matchLen = 1;
            while(c + matchLen < this.cols && isMatch(t, this.grid[r][c+matchLen])) matchLen++;
            if(matchLen >= 3) {
              for(let i=0; i<matchLen; i++) matchedSet.add(this.grid[r][c+i]);
              c += matchLen - 1;
            }
          }
        }
        // Vertical
        for(let c=0; c<this.cols; c++) {
          for(let r=0; r<this.rows-2; r++) {
            let t = this.grid[r][c];
            if(!t) continue;
            let matchLen = 1;
            while(r + matchLen < this.rows && isMatch(t, this.grid[r+matchLen][c])) matchLen++;
            if(matchLen >= 3) {
              for(let i=0; i<matchLen; i++) matchedSet.add(this.grid[r+i][c]);
              r += matchLen - 1;
            }
          }
        }
        return Array.from(matchedSet);
      },

      async processMatches(matches) {
        this.state = 'ANIMATING';
        
        // 1. Calculate Score & Boss Damage
        let points = matches.length * 10 * this.stats.combo;
        this.stats.score += points;
        
        if (this.boss && this.boss.active) {
            this.damageBoss(matches.length);
        }

        // 2. Evolution Logic (Fledernuss)
        let toRemove = [...matches];
        const fleders = matches.filter(t => t.type === 'fleder');
        
        if (fleders.length >= 3) {
           // Find center of match (simplified: first one survives)
           const survivor = fleders[0];
           if (survivor.evo < 3) {
               survivor.evo++;
               toRemove = toRemove.filter(t => t.id !== survivor.id); // Keep survivor
               
               // Update Visuals
               const el = this.tiles.get(survivor.id);
               el.dataset.evo = survivor.evo;
               FX.textFloat(el.offsetLeft, el.offsetTop, "EVOLUTION!", "#a35eff");
               AudioMan.play('evolve');
           } else {
               // Stage 3 Boom
               this.showToast("SUPER NUSS!", "Board Blast!", ASSETS.fleder);
               // TODO: Explosion logic (remove surroundings)
           }
        }

        // 3. Remove Tiles
        for (let t of toRemove) {
           const el = this.tiles.get(t.id);
           el.classList.add('matched');
           
           // FX
           const rect = el.getBoundingClientRect();
           const boardRect = document.getElementById('grid').getBoundingClientRect();
           FX.spawn(rect.left - boardRect.left + 25, rect.top - boardRect.top + 25, t.color);
           
           this.grid[t.r][t.c] = null;
           // Delay removal for anim
           setTimeout(() => { el.remove(); this.tiles.delete(t.id); }, 300);
        }
        AudioMan.play('pop');
        
        await new Promise(r => setTimeout(r, 350));

        // 4. Gravity & Refill
        await this.applyGravity();
        
        // 5. Chain Reaction?
        const newMatches = this.findMatches();
        if (newMatches.length > 0) {
          this.stats.combo++;
          await this.processMatches(newMatches);
        } else {
          // Check Win/Loss
          this.checkGameStatus();
        }
      },

      async applyGravity() {
        // Fall down
        for(let c=0; c<this.cols; c++) {
            let writePtr = this.rows - 1;
            for(let r=this.rows-1; r>=0; r--) {
                if (this.grid[r][c]) {
                    if (writePtr !== r) {
                        // Move
                        const t = this.grid[r][c];
                        this.grid[writePtr][c] = t;
                        this.grid[r][c] = null;
                        t.r = writePtr; 
                        t.c = c;
                        
                        const el = this.tiles.get(t.id);
                        el.classList.add('dropping');
                        el.style.setProperty('--r', writePtr);
                        // cleanup class later
                        setTimeout(() => el.classList.remove('dropping'), 400);
                    }
                    writePtr--;
                }
            }
            // Fill top
            for(let r=writePtr; r>=0; r--) {
                let newT = this.randomTileType();
                this.createTile(r, c, newT); // Creates visual at correct pos but needs drop anim
                // Hack: Visual drop from above board?
                // For now, simple spawn
            }
        }
        await new Promise(r => setTimeout(r, 450));
      },

      // --- BOSS & SPECIALS ---
      spawnBoss() {
        this.boss = { active: true, hp: 50, maxHp: 50 };
        const overlay = document.createElement('div');
        overlay.className = 'boss-overlay';
        // Center Position
        overlay.style.left = `calc(3 * (${getComputedStyle(document.documentElement).getPropertyValue('--cell')} + ${getComputedStyle(document.documentElement).getPropertyValue('--gap')}))`;
        overlay.style.top = `calc(3 * (${getComputedStyle(document.documentElement).getPropertyValue('--cell')} + ${getComputedStyle(document.documentElement).getPropertyValue('--gap')}))`;
        
        overlay.innerHTML = `
            <img src="${ASSETS.mellow}" class="boss-img">
            <div class="boss-hp-bar"><div class="boss-hp-fill" id="boss-hp"></div></div>
            <div style="color:white; font-weight:bold; margin-top:5px;">MELLOW ZILLA</div>
        `;
        document.getElementById('boss-layer').appendChild(overlay);
        this.showToast("WARNUNG!", "MellowZilla ist da!", ASSETS.mellow);
        AudioMan.play('boss_spawn');
      },

      damageBoss(amount) {
        const dmg = amount * 2;
        this.boss.hp -= dmg;
        const pct = (this.boss.hp / this.boss.maxHp) * 100;
        document.getElementById('boss-hp').style.width = Math.max(0, pct) + "%";
        
        const bossEl = document.querySelector('.boss-overlay');
        bossEl.classList.add('hit');
        setTimeout(() => bossEl.classList.remove('hit'), 400);

        if (this.boss.hp <= 0) {
            this.bossDefeated();
        }
      },

      bossDefeated() {
        this.boss.active = false;
        document.querySelector('.boss-overlay').style.transform = "scale(0) rotate(360deg)";
        this.stats.score += 5000;
        this.showToast("SIEG!", "MellowZilla besiegt! (+5000)", ASSETS.sweety);
        setTimeout(() => document.getElementById('boss-layer').innerHTML = '', 1000);
      },

      checkGameStatus() {
        this.state = 'IDLE';
        // Level Up?
        const target = DIFFICULTY[this.settings.diff].targetBase * this.stats.level;
        if (this.stats.score >= target) {
            this.stats.level++;
            this.stats.moves += 15;
            this.showToast("LEVEL UP!", `Willkommen in Level ${this.stats.level}`, ASSETS.simba);
            this.setupLevel();
        }
        // Game Over?
        else if (this.stats.moves <= 0) {
            this.gameOver();
        } else {
            // Smart Shuffle Check?
            // If no moves, shuffle (Smart Shuffle: Keep borders)
            // Implementation simplified: just check random sample for now
        }
        this.updateUI();
      },

      gameOver() {
        document.getElementById('modal-gameover').classList.add('active');
        document.getElementById('go-score').innerText = this.stats.score;
      },

      // --- UI UPDATES ---
      updateUI() {
        document.getElementById('ui-score').innerText = this.stats.score;
        document.getElementById('ui-lvl').innerText = this.stats.level;
        document.getElementById('ui-moves').innerText = this.stats.moves;
        document.getElementById('ui-combo').innerText = "x" + this.stats.combo;
        
        const target = DIFFICULTY[this.settings.diff].targetBase * this.stats.level;
        document.getElementById('ui-target').innerText = target;
        
        const pct = Math.min(100, (this.stats.score / target) * 100);
        document.getElementById('ui-prog').style.width = pct + "%";
      },

      showToast(title, msg, img) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerHTML = `${img ? `<img src="${img}">` : ''}<div><div>${title}</div><div style="font-weight:400; font-size:12px; opacity:0.8">${msg}</div></div>`;
        document.getElementById('toast-container').appendChild(t);
        
        // Anim
        requestAnimationFrame(() => t.classList.add('show'));
        setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 300);
        }, 3000);
      },
      
      toggleDark() {
          document.body.classList.toggle('dark-mode');
      },
      
      hint() {
         if(this.stats.moves <= 2) return;
         this.stats.moves -= 2;
         this.updateUI();
         // Naive Hint implementation
         const tiles = Array.from(this.tiles.values());
         const rand = tiles[Math.floor(Math.random()*tiles.length)];
         rand.classList.add('hint');
         setTimeout(()=>rand.classList.remove('hint'), 1500);
      }
    };

    // --- INITIALIZATION ---
    window.onload = () => {
        // Show Start Modal
        document.getElementById('modal-start').classList.add('active');
        
        // Listeners
        document.getElementById('btn-new').onclick = () => Game.start(); // Restart via modal flow
        document.getElementById('btn-darkmode').onclick = () => Game.toggleDark();
        document.getElementById('btn-hint').onclick = () => Game.hint();
        
        // Difficulty Switcher
        document.querySelectorAll('.diff-opt').forEach(btn => {
            btn.onclick = (e) => {
                document.querySelectorAll('.diff-opt').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                Game.settings.diff = e.target.dataset.diff;
            };
        });
    };

  </script>
</body>
</html>
