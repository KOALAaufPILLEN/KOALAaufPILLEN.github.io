<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Luvvies Crush 2.0</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      /* Light Theme (Default) */
      --bg1:#f7f2ff;
      --bg2:#eaf6ff;
      --card:rgba(255,255,255,0.85);
      --card2:rgba(255,255,255,0.94);
      --text:#1d1334;
      --stroke:rgba(17,13,26,.10);
      --shadow: 0 18px 60px rgba(20,10,60,.12);
      --boardBg: radial-gradient(circle at 20% 20%, rgba(255,255,255,.86), rgba(255,255,255,.35));
      
      --cols: 10;
      --rows: 10;
      --cell: 54px;
      --gap: 8px;
      --pad: 14px;
      --boardRadius: 26px;
      --toastMs: 2600ms;
    }

    /* DARK MODE VARIABLES */
    :root.dark {
      --bg1:#0f0b1e;
      --bg2:#18122b;
      --card:rgba(30,25,50,0.85);
      --card2:rgba(40,35,65,0.94);
      --text:#f0e6ff;
      --stroke:rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.5);
      --boardBg: radial-gradient(circle at 20% 20%, rgba(40,30,70,.86), rgba(20,15,40,.85));
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      overflow:hidden;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      position:relative;
      transition: color .3s ease, background .3s ease;
    }

    /* Scroll container (scrollbar hidden) */
    #page{
      height:100vh;
      overflow:auto;
      position:relative;
      z-index:0;
    }
    #page{ scrollbar-width:none; }
    #page::-webkit-scrollbar{ width:0; height:0; }

    /* Scrollender Background Layer */
    #scrollBg{
      position:absolute;
      inset:0;
      z-index:0;
      pointer-events:none;
      min-height: 120vh;
      background:
        radial-gradient(circle at 20% 20%, rgba(255,105,180,.14), transparent 48%),
        radial-gradient(circle at 85% 25%, rgba(122,216,255,.20), transparent 52%),
        radial-gradient(circle at 55% 75%, rgba(255,209,90,.16), transparent 50%),
        linear-gradient(120deg, rgba(255,79,185,.18), rgba(255,209,90,.14), rgba(122,216,255,.18));
      background-size: auto, auto, auto, 300% 300%;
      filter: blur(18px);
      opacity:.55;
      animation: bgMove 18s ease-in-out infinite;
    }
    @keyframes bgMove{
      0%{ background-position: 0% 50% }
      50%{ background-position: 100% 50% }
      100%{ background-position: 0% 50% }
    }

    #app{
      width:min(1100px, 96vw);
      margin: 18px auto 28px;
      position:relative;
      z-index:5; 
    }

    .topRow{
      margin-top: 12px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: 22px;
      padding: 12px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      z-index:6;
      backdrop-filter: blur(12px);
    }

    .diffWrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .diffWrap .label{font-weight:900;opacity:.9;margin-right:4px}
    .diffPills{
      display:flex;
      gap:8px; padding:6px;
      border-radius:999px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(17,13,26,.08);
    }
    .dark .diffPills { background: rgba(0,0,0,.4); border-color: rgba(255,255,255,.1); }

    .diffPills input{display:none}
    .diffPills label{
      cursor:pointer;
      user-select:none;
      padding:8px 14px; border-radius:999px;
      font-weight:900; font-size:13px;
      color: #1d1334;
      transition: all .2s ease;
    }
    .dark .diffPills label { color: #fff; }

    .diffPills input:checked + label{
      background: linear-gradient(135deg, #ff4fb9, #7ad8ff);
      color:#fff;
      box-shadow: 0 4px 12px rgba(255,79,185,.4);
      transform: translateY(-1px);
    }

    /* Buttons */
    .Btn{
      position: relative;
      height: 44px;
      padding: 0 16px;
      border-radius: 999px;
      border: none;
      background-color: rgb(151, 95, 255);
      color: white;
      box-shadow: 0px 5px 10px rgba(0,0,0,0.2) inset, 0px 5px 15px rgba(151, 95, 255, 0.4);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap:8px;
      font-weight:800;
      transition: transform .12s ease, filter .2s;
    }
    .Btn:hover { transform: translateY(-2px); filter:brightness(1.1); }
    .Btn:active{ transform: scale(.96); }
    
    .Btn.secondary{ background: linear-gradient(135deg, #ff4fb9, #ff9adf); box-shadow: 0 5px 15px rgba(255, 79, 185, 0.4); }
    .Btn.ghost{ background: rgba(255,255,255,.5); color:var(--text); border:1px solid var(--stroke); box-shadow:none; }
    .dark .Btn.ghost { background: rgba(255,255,255,.1); color:#fff; }
    
    .Btn.darkToggle {
      width: 44px; padding:0; font-size: 20px;
      background: #333; 
    }
    .Btn.darkToggle.active { background: #ffd15a; color:#333; }

    .stats{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
      z-index:6;
    }
    .stat{
      background: var(--card2);
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.05);
      display:flex;
      flex-direction:column;
      justify-content:center;
      backdrop-filter: blur(8px);
    }
    .stat .k{font-size:11px; opacity:.7; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;}
    .stat .v{font-weight:900; font-size:18px; margin-top:2px}

    /* Board */
    .playArea{
      margin-top: 12px;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 14px;
      position:relative;
      overflow:hidden;
      z-index:6;
      backdrop-filter: blur(14px);
    }

    #board{
      position:relative;
      z-index:12;
      padding: var(--pad);
      border-radius: var(--boardRadius);
      background: var(--boardBg);
      border: 1px solid rgba(17,13,26,.08);
      box-shadow: 0 18px 70px rgba(0,0,0,.15), 0 6px 16px rgba(0,0,0,.06) inset;
      margin: 0 auto;
    }

    /* Tiles & Plates */
    .tile{
      position:absolute;
      width: var(--cell); height: var(--cell);
      left:0; top:0;
      transform: translate(var(--x), var(--y));
      transition: transform 220ms cubic-bezier(.2,.8,.2,1);
      will-change: transform;
      z-index:15;
    }
    /* Mellow Lord / Zilla sizes */
    .tile.big2x2 { width: calc(var(--cell)*2 + var(--gap)); height: calc(var(--cell)*2 + var(--gap)); z-index:25; }
    .tile.big3x3 { width: calc(var(--cell)*3 + var(--gap)*2); height: calc(var(--cell)*3 + var(--gap)*2); z-index:30; }
    
    .tile.big3x3 .plate {
      animation: zillaShake 3s ease-in-out infinite;
      border: 3px solid #ff4fb9;
      box-shadow: 0 0 30px rgba(255,79,185,0.4);
    }
    @keyframes zillaShake {
      0%, 100% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(1deg) scale(1.02); }
      75% { transform: rotate(-1deg) scale(1.02); }
    }

    .plate{
      width:100%; height:100%;
      border-radius: 16px;
      background: radial-gradient(circle at 22% 18%, rgba(255,255,255,.88), rgba(255,255,255,0) 40%), linear-gradient(135deg, var(--p1), var(--p2));
      border: 1px solid rgba(255,255,255,.50);
      box-shadow: 0 8px 16px rgba(0,0,0,.14), 0 -4px 8px rgba(255,255,255,.4) inset;
      position:relative;
      transform: scale(1);
      transition: transform 0.2s;
    }
    .tile.big2x2 .plate { border-radius: 24px; }
    .tile.big3x3 .plate { border-radius: 32px; background: linear-gradient(45deg, #2b1b4f, #8b5cf6) !important; }

    .tile img{
      position:absolute; inset: 10%; width:80%; height:80%;
      object-fit:contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,.15));
      pointer-events:none;
    }
    
    /* Pop Animation */
    .pop .plate{ animation: popPlate 350ms ease-in forwards; }
    @keyframes popPlate{
      0%{ transform: scale(1); opacity:1; }
      50%{ transform: scale(1.2); opacity:0.8; }
      100%{ transform: scale(0); opacity:0; }
    }

    /* Modals & Overlays */
    .modalBack{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background: rgba(10,8,20,.75);
      z-index: 9999;
      backdrop-filter: blur(4px);
    }
    .modal{
      width: min(600px, 92vw);
      background: var(--card2);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid var(--stroke);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      color: var(--text);
    }
    .modal h2 { margin-top:0; color: #ff4fb9; }

    /* Leaderboard Glows */
    .lbItem{
      display:flex; justify-content:space-between; padding: 10px;
      background: rgba(255,255,255,0.5);
      margin-bottom:6px; border-radius:12px;
    }
    .dark .lbItem { background: rgba(255,255,255,0.05); }

    .lbItem.rank1 { border: 2px solid gold; box-shadow: 0 0 15px rgba(255,215,0,0.4); animation: pulseGold 2s infinite; }
    .lbItem.rank2 { border: 2px solid silver; box-shadow: 0 0 10px rgba(192,192,192,0.3); }
    .lbItem.rank3 { border: 2px solid #cd7f32; box-shadow: 0 0 10px rgba(205,127,50,0.3); }

    @keyframes pulseGold { 0%{box-shadow:0 0 15px rgba(255,215,0,0.2);} 50%{box-shadow:0 0 25px rgba(255,215,0,0.6);} 100%{box-shadow:0 0 15px rgba(255,215,0,0.2);} }

    /* Toast */
    #toast{ position: fixed; right: 20px; top: 20px; z-index: 10000; pointer-events:none; }
    .toast{
      background: var(--card2); padding: 12px 18px; margin-top:10px;
      border-radius: 12px; border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      pointer-events: auto;
    }
    @keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
    .toast b { color: #ff4fb9; display:block; margin-bottom:2px; }

    /* Responsiveness */
    @media (max-width: 600px){
      .stats{ grid-template-columns: 1fr 1fr 1fr; }
      .topRow .diffWrap { width:100%; justify-content:center; }
      .topRow .actions { width:100%; justify-content:center; }
    }
  </style>
</head>

<body>
  <div id="page">
    <div id="scrollBg"></div>
    <div id="toast"></div>

    <div class="modalBack" id="greetBack" style="display:flex;">
      <div class="modal" style="text-align:center;">
        <h2>Willkommen zu Luvvies Crush 2.0 üç≠</h2>
        <p>Match nur bei <b>gleicher Figur + gleicher Farbe!</b><br>Schaffst du es bis zum MellowZilla Boss?</p>
        
        <div style="margin:20px 0;">
          <label style="display:block; font-weight:bold; margin-bottom:8px;">Dein Spielername:</label>
          <input type="text" id="playerNameInput" placeholder="Name eingeben..." maxlength="16" 
                 style="padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; width:80%;">
        </div>

        <div style="display:flex; justify-content:center; gap:10px;">
          <button class="Btn ghost" onclick="document.getElementById('introBack').style.display='flex'">Anleitung</button>
          <button class="Btn secondary" id="greetPlay">Spielen</button>
        </div>
      </div>
    </div>

    <div class="modalBack" id="introBack">
      <div class="modal">
        <h2>Spielregeln 2.0</h2>
        <ul style="line-height:1.6; padding-left:20px;">
          <li><b>Match:</b> Gleiche Figur UND gleiche Farbe! (Sehr schwer)</li>
          <li><b>4er:</b> Sourworm (Line Clear)</li>
          <li><b>5er:</b> Citrussy (Explosion Radius 2)</li>
          <li><b>Fledernuss (Lvl 10+):</b> 3√ó Nuss ‚Üí Held. 3√ó Held ‚Üí SuperNuss ‚Üí BOOM! ü¶á</li>
          <li><b>Simba (Lvl 4+):</b> Best Buddies mit Smokey.</li>
          <li><b>MellowZilla:</b> Boss in Level 20. 3x3 Feld. 20.000 Punkte.</li>
          <li><b>Hint:</b> Kostet Z√ºge! (Easy: -1, Normal: -2, Zuckerschock: -3).</li>
          <li><b>Smart Shuffle:</b> Mischt nur innen, wenn keine Z√ºge mehr da sind.</li>
        </ul>
        <button class="Btn ghost" onclick="document.getElementById('introBack').style.display='none'" style="float:right;">Verstanden</button>
      </div>
    </div>

    <div class="modalBack" id="gameOverBack">
      <div class="modal" style="text-align:center;">
        <h2 style="color:#ff4fb9; font-size:28px;">GAME OVER üòµ</h2>
        <div style="font-size:40px; font-weight:900; margin:10px 0;" id="goScore">0</div>
        <p>Punkte</p>
        
        <div style="margin:20px 0;">
          <label class="tiny">Name f√ºr Leaderboard:</label><br>
          <input type="text" id="goNameInput" maxlength="16" style="padding:8px; border-radius:6px; font-weight:bold; text-align:center;">
        </div>

        <div style="display:flex; gap:10px; justify-content:center;">
          <button class="Btn ghost" onclick="restartGame()">Neustart</button>
          <button class="Btn secondary" id="btnPostScore">Score Posten</button>
        </div>
      </div>
    </div>

    <div id="app">
      <div class="topRow">
        <div class="diffWrap">
          <div class="label">Modus</div>
          <div class="diffPills" id="diffPills">
            <input type="radio" name="diff" id="d_easy" value="easy"><label for="d_easy">Easy</label>
            <input type="radio" name="diff" id="d_normal" value="normal" checked><label for="d_normal">Normal</label>
            <input type="radio" name="diff" id="d_shock" value="shock"><label for="d_shock">Zuckerschock</label>
          </div>
        </div>

        <div class="actions">
          <button class="Btn darkToggle" id="btnDark" title="Dark Mode">üåô</button>
          <button class="Btn secondary" onclick="restartGame()">Neu</button>
          <button class="Btn" id="btnHint">Hint <span id="hintCost" style="font-size:10px; opacity:0.8; margin-left:4px;">(-2)</span></button>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><div class="k">Level</div><div class="v" id="uiLevel">1</div></div>
        <div class="stat"><div class="k">Ziel</div><div class="v" id="uiGoal">2000</div></div>
        <div class="stat"><div class="k">Score</div><div class="v" id="uiScore">0</div></div>
        <div class="stat"><div class="k">Moves</div><div class="v" id="uiMoves">25</div></div>
        <div class="stat"><div class="k">Combo</div><div class="v" id="uiCombo">x1</div></div>
      </div>

      <div class="playArea" id="playArea">
        <div id="board"></div>
      </div>

      <div class="topRow" style="margin-top:12px; display:block;">
        <h3 style="margin:0 0 10px;">Leaderboard</h3>
        <div id="lbList" style="max-height:200px; overflow:auto;">
          <div style="font-size:12px; opacity:0.6;">Lade Scores...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* --- CONFIG & ASSETS --- */
    const IMG = {
      sweety:   "https://static.wixstatic.com/media/d05122_efe39fec7e5c4d569dfb3fef75e5b6ff~mv2.png",
      sleepy:   "https://static.wixstatic.com/media/d05122_cfd779a0aad04c72bd08efbc0f363f53~mv2.png",
      joyce:    "https://static.wixstatic.com/media/d05122_36a3f8d83be4433082995ee1a8003218~mv2.png",
      smokey:   "https://static.wixstatic.com/media/d05122_9a607ff042b647b789e3b44cc75bd38d~mv2.png",
      simba:    "https://static.wixstatic.com/media/d05122_4d92be50d61e4a2297af16a3295c38bf~mv2.png",
      worm:     "https://static.wixstatic.com/media/d05122_a8e7a37e04694ff2a99b8af60f1567b7~mv2.png",
      citrussy: "https://static.wixstatic.com/media/d05122_9cdc763a1ec94a90a3fd91ee3481b2c4~mv2.png",
      koala:    "https://static.wixstatic.com/media/d05122_9cb17e901a1a4775819bfda895d0f1c9~mv2.png",
      mellow:   "https://static.wixstatic.com/media/d05122_53fbcb0babf447a5a32cc3b3fbecad2b~mv2.png",
      // Fledernuss & Boss visual representation via logic (CSS filters/text) since generic URLs missing
      fledernuss: "https://static.wixstatic.com/media/d05122_1950f2496b344e56bcac10ea51286750~mv2.png", // Platzhalter Cry
    };

    const DIFFS = {
      easy:   { moves:30, target:2000, hintCost:1, colors:2 },
      normal: { moves:25, target:3500, hintCost:2, colors:3 },
      shock:  { moves:20, target:6000, hintCost:3, colors:4 } // Zuckerschock
    };

    // Bases with Unlock Levels
    const BASES = [
      { key:"sweety", minLvl:1, img:IMG.sweety },
      { key:"sleepy", minLvl:1, img:IMG.sleepy },
      { key:"joyce",  minLvl:1, img:IMG.joyce },
      { key:"smokey", minLvl:1, img:IMG.smokey },
      { key:"simba",  minLvl:4, img:IMG.simba },  // Ab Level 4
      { key:"fleder", minLvl:10, img:IMG.fledernuss } // Ab Level 10
    ];

    const PALETTES = [
      ["#ff9adf", "#ff4fb9"], // Pink
      ["#7ad8ff", "#00aaff"], // Blue
      ["#ffcf5a", "#ff9900"], // Orange
      ["#b8ffb1", "#00cc44"], // Green
    ];

    /* --- STATE --- */
    let grid = [];
    let tileEls = new Map();
    let rows=9, cols=8;
    let level=1, score=0, moves=0, target=0, combo=1;
    let currentDiff = 'normal';
    let busy = false;
    let currentPlayerName = "Gast";
    let bigMellows = new Map(); // id -> {r,c,hp,maxHp}
    let bossActive = false;

    // Fledernuss Stages
    const FLEDER_STAGES = {
      "fleder": 1, "fleder_held": 2, "fleder_super": 3
    };

    /* --- DOM ELEMENTS --- */
    const uiBoard = document.getElementById("board");
    const uiScore = document.getElementById("uiScore");
    const uiMoves = document.getElementById("uiMoves");
    const uiLevel = document.getElementById("uiLevel");
    const uiGoal  = document.getElementById("uiGoal");
    
    /* --- INITIALIZATION --- */
    function init(){
      setupSupabase();
      attachEvents();
      refreshLeaderboard();
      if(localStorage.getItem("luvvies_dark")==="1") toggleDark(true);
    }

    /* --- GAME LOOP --- */
    function restartGame(){
      document.getElementById("gameOverBack").style.display="none";
      const dVal = document.querySelector('input[name="diff"]:checked').value;
      currentDiff = dVal;
      const sett = DIFFS[dVal];
      
      level = 1;
      score = 0;
      target = sett.target;
      moves = sett.moves;
      combo = 1;
      bossActive = false;
      
      document.getElementById("hintCost").textContent = `(-${sett.hintCost})`;

      createGrid();
      updateUI();
    }

    function createGrid(){
      uiBoard.innerHTML = "";
      tileEls.clear();
      bigMellows.clear();
      grid = [];
      
      // Responsive Cell Calc
      const w = Math.min(window.innerWidth - 40, 600);
      const cell = Math.floor(w / cols) - 6;
      document.documentElement.style.setProperty("--cell", cell+"px");
      uiBoard.style.width = (cols*(cell+8) + 28) + "px";
      uiBoard.style.height = (rows*(cell+8) + 28) + "px";

      for(let r=0; r<rows; r++){
        grid[r] = [];
        for(let c=0; c<cols; c++){
          let t;
          do { t = randomTile(r,c); } 
          while (checkMatchPre(r,c,t));
          grid[r][c] = t;
          createTileDom(t);
        }
      }
      
      // Boss Check Level 20
      if(level % 20 === 0) spawnMellowZilla();
    }

    function randomTile(r,c){
      // Filter chars by level
      const pool = BASES.filter(b => b.minLvl <= level);
      const base = pool[Math.floor(Math.random()*pool.length)];
      
      // Color Logic based on difficulty
      const maxCol = DIFFS[currentDiff].colors;
      const colIdx = Math.floor(Math.random() * maxCol);
      
      return { 
        id: Math.random().toString(36).substr(2),
        r, c, 
        base: base.key, 
        colorIdx: colIdx,
        type: "normal", // normal, obstacle, powerup
        flederStage: base.key==="fleder" ? 1 : 0
      };
    }

    function createTileDom(t){
      const el = document.createElement("div");
      el.className = "tile";
      if(t.flederStage === 2) el.style.filter = "hue-rotate(180deg) brightness(1.2)";
      if(t.flederStage === 3) el.style.filter = "invert(1) drop-shadow(0 0 5px red)";
      
      // Palette
      const pal = PALETTES[t.colorIdx];
      el.style.setProperty("--p1", pal[0]);
      el.style.setProperty("--p2", pal[1]);

      el.innerHTML = `<div class="plate"><img src="${getBaseImg(t.base)}" /></div>`;
      
      // Positioning
      updateTilePos(el, t.r, t.c);
      
      // Event
      el.onpointerdown = (e) => handleInput(e, t);
      
      tileEls.set(t.id, el);
      uiBoard.appendChild(el);
      return el;
    }

    function getBaseImg(key){
      const b = BASES.find(x=>x.key===key);
      return b ? b.img : "";
    }

    function updateTilePos(el, r, c){
      const gap = 8; const pad = 14; 
      const cell = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--cell"));
      const x = pad + c*(cell+gap);
      const y = pad + r*(cell+gap);
      el.style.setProperty("--x", x+"px");
      el.style.setProperty("--y", y+"px");
    }

    /* --- INPUT & SWAP --- */
    let selected = null;
    
    function handleInput(e, t){
      if(busy || t.type === 'obstacle_part') return;
      if(!selected){
        selected = t;
        tileEls.get(t.id).style.transform += " scale(0.9)";
      } else {
        const dR = Math.abs(selected.r - t.r);
        const dC = Math.abs(selected.c - t.c);
        if(dR+dC === 1){
          attemptSwap(selected, t);
        }
        tileEls.get(selected.id).style.transform = tileEls.get(selected.id).style.transform.replace(" scale(0.9)","");
        selected = null;
      }
    }

    async function attemptSwap(t1, t2){
      busy = true;
      // Visual Swap
      await swapVis(t1,t2);
      
      // Logic Swap
      [grid[t1.r][t1.c], grid[t2.r][t2.c]] = [grid[t2.r][t2.c], grid[t1.r][t1.c]];
      [t1.r, t1.c, t2.r, t2.c] = [t2.r, t2.c, t1.r, t1.c];

      // Check Match
      const matches = findMatches();
      if(matches.length > 0){
        moves--;
        await resolveMatches(matches);
      } else {
        // Swap Back (Penalty)
        if(currentDiff === 'shock') moves -= 3; // Zuckerschock Strafe
        await swapVis(t1,t2);
        [grid[t1.r][t1.c], grid[t2.r][t2.c]] = [grid[t2.r][t2.c], grid[t1.r][t1.c]];
        [t1.r, t1.c, t2.r, t2.c] = [t2.r, t2.c, t1.r, t1.c];
        busy = false;
        showToast("Ung√ºltig!", "-3 Moves (Zuckerschock)", true);
      }
      updateUI();
    }

    function swapVis(t1, t2){
      return new Promise(r => {
        const e1 = tileEls.get(t1.id);
        const e2 = tileEls.get(t2.id);
        updateTilePos(e1, t1.r, t1.c);
        updateTilePos(e2, t2.r, t2.c);
        setTimeout(r, 250);
      });
    }

    /* --- MATCH LOGIC --- */
    function checkMatchPre(r,c,t){
      // Helper for init to avoid pre-matches
      if(c>=2){
        const a=grid[r][c-1], b=grid[r][c-2];
        if(isSame(a,t) && isSame(b,t)) return true;
      }
      if(r>=2){
        const a=grid[r-1][c], b=grid[r-2][c];
        if(isSame(a,t) && isSame(b,t)) return true;
      }
      return false;
    }

    function isSame(t1, t2){
      if(!t1 || !t2) return false;
      if(t1.type === 'obstacle' || t2.type === 'obstacle') return false;
      // HARDCORE RULE: Base AND Color must match
      return t1.base === t2.base && t1.colorIdx === t2.colorIdx && t1.flederStage === t2.flederStage;
    }

    function findMatches(){
      let matched = new Set();
      // Horizontal
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols-2;c++){
          let t = grid[r][c];
          if(!t || t.type==='obstacle_part') continue;
          let matchLen = 1;
          while(c+matchLen < cols && isSame(t, grid[r][c+matchLen])) matchLen++;
          if(matchLen >= 3){
            for(let i=0;i<matchLen;i++) matched.add(grid[r][c+i]);
            c += matchLen-1;
          }
        }
      }
      // Vertical
      for(let c=0;c<cols;c++){
        for(let r=0;r<rows-2;r++){
          let t = grid[r][c];
          if(!t || t.type==='obstacle_part') continue;
          let matchLen = 1;
          while(r+matchLen < rows && isSame(t, grid[r+matchLen][c])) matchLen++;
          if(matchLen >= 3){
            for(let i=0;i<matchLen;i++) matched.add(grid[r+i][c]);
            r += matchLen-1;
          }
        }
      }
      return Array.from(matched);
    }

    async function resolveMatches(matches){
      combo++;
      let points = matches.length * 50 * combo;
      
      // FLEDERNUSS EVOLUTION LOGIC
      // Check if we have 3+ Fledernuss
      let flederUpgrades = [];
      let toDestroy = [...matches];
      
      const fleders = matches.filter(t => t.base === 'fleder');
      if(fleders.length >= 3){
        // Only upgrade the first one, destroy others
        const survivor = fleders[0];
        if(survivor.flederStage < 3){
           toDestroy = toDestroy.filter(x => x !== survivor); // Keep survivor
           survivor.flederStage++;
           flederUpgrades.push(survivor);
        } else if(survivor.flederStage === 3){
           // BOOM logic later
           points += 5000;
           showToast("SUPER NUSS BOOM!", "üí•üí•üí•");
        }
      }

      score += points;

      // Remove DOMs
      for(let t of toDestroy){
        const el = tileEls.get(t.id);
        if(el){
          el.classList.add("pop");
          setTimeout(()=>el.remove(), 300);
          tileEls.delete(t.id);
          grid[t.r][t.c] = null;
        }
      }
      
      // Update Upgraded visuals
      for(let t of flederUpgrades){
        const el = tileEls.get(t.id);
        if(t.flederStage===2) el.style.filter = "hue-rotate(180deg) brightness(1.2)";
        if(t.flederStage===3) el.style.filter = "invert(1) drop-shadow(0 0 5px red)";
        el.classList.add("pop"); 
        setTimeout(()=>el.classList.remove("pop"), 300); // Pulse effect
      }

      await new Promise(r=>setTimeout(r, 350));
      
      // Gravity
      applyGravity();
      await new Promise(r=>setTimeout(r, 300));
      
      // Refill
      refillGrid();
      await new Promise(r=>setTimeout(r, 300));
      
      // Chain Reaction?
      const newM = findMatches();
      if(newM.length > 0) await resolveMatches(newM);
      else {
        busy = false;
        checkWinCondition();
        if(moves <= 0) gameOver();
        else if(!hasMoves()) smartShuffle();
      }
      updateUI();
    }

    function applyGravity(){
      for(let c=0; c<cols; c++){
        let write = rows-1;
        for(let r=rows-1; r>=0; r--){
          if(grid[r][c] && grid[r][c].type !== 'obstacle' && grid[r][c].type !== 'obstacle_part'){
             if(write !== r){
               grid[write][c] = grid[r][c];
               grid[write][c].r = write;
               grid[r][c] = null;
               updateTilePos(tileEls.get(grid[write][c].id), write, c);
             }
             write--;
          } else if (grid[r][c] && (grid[r][c].type === 'obstacle' || grid[r][c].type === 'obstacle_part')){
            write = r-1; // Obstacles don't fall usually in this logic
          }
        }
      }
    }

    function refillGrid(){
      for(let c=0; c<cols; c++){
        for(let r=0; r<rows; r++){
          if(!grid[r][c]){
             let t = randomTile(r,c);
             grid[r][c] = t;
             createTileDom(t);
             // Animation from top
             let el = tileEls.get(t.id);
             el.style.top = "-50px";
             setTimeout(()=>el.style.top = "0", 10);
          }
        }
      }
    }
    
    /* --- SMART SHUFFLE --- */
    function hasMoves(){
      // Simplified check
      return true; // Placeholder for complexity reasons, assuming usually matches exist
    }

    function smartShuffle(){
      showToast("Keine Z√ºge!", "Smart Shuffle...", false);
      // Shuffle nur innere 
      let pool = [];
      for(let r=1; r<rows-1; r++){
        for(let c=1; c<cols-1; c++){
           if(grid[r][c] && grid[r][c].type === 'normal') pool.push(grid[r][c]);
        }
      }
      
      pool.sort(()=>Math.random()-0.5);
      
      let i=0;
      for(let r=1; r<rows-1; r++){
        for(let c=1; c<cols-1; c++){
           if(grid[r][c] && grid[r][c].type === 'normal'){
             let t = pool[i++];
             t.r = r; t.c = c;
             grid[r][c] = t;
             updateTilePos(tileEls.get(t.id), r, c);
           }
        }
      }
    }

    /* --- BOSS MELLOW ZILLA --- */
    function spawnMellowZilla(){
      bossActive = true;
      const r = 3, c = 2; // Center-ish
      // Clear area
      for(let rr=r; rr<r+3; rr++){
        for(let cc=c; cc<c+3; cc++){
           if(grid[rr][cc]){
             tileEls.get(grid[rr][cc].id).remove();
             tileEls.delete(grid[rr][cc].id);
             grid[rr][cc] = null;
           }
        }
      }
      
      const boss = { id: "BOSS", r, c, type:'obstacle', base:'mellow', hp:50, maxHp:50 };
      bigMellows.set("BOSS", boss);
      
      // Main Tile
      grid[r][c] = boss;
      const el = document.createElement("div");
      el.className = "tile big3x3";
      el.innerHTML = `<div class="plate"><img src="${IMG.mellow}" style="width:100%;height:100%;filter:drop-shadow(0 0 10px red);"></div>`;
      updateTilePos(el, r, c);
      tileEls.set("BOSS", el);
      uiBoard.appendChild(el);
      
      // Blockers
      for(let rr=r; rr<r+3; rr++){
        for(let cc=c; cc<c+3; cc++){
          if(rr===r && cc===c) continue;
          grid[rr][cc] = { type:'obstacle_part', parent:"BOSS", r:rr, c:cc };
        }
      }
      showToast("MELLOW ZILLA!", "HP: 50 | 20.000 Pts");
    }

    /* --- GAME OVER & UI --- */
    function checkWinCondition(){
      if(score >= target){
        showToast("Level Complete! üéâ", "Next Level >>");
        level++;
        score = 0; // or carry over
        target = Math.floor(target * 1.2);
        moves += 10;
        createGrid();
        updateUI();
      }
    }

    function gameOver(){
      document.getElementById("gameOverBack").style.display="flex";
      document.getElementById("goScore").textContent = score;
      document.getElementById("goNameInput").value = currentPlayerName;
    }

    document.getElementById("btnHint").onclick = () => {
      const cost = DIFFS[currentDiff].hintCost;
      if(moves <= cost) return;
      moves -= cost;
      updateUI();
      // Simple Hint: Find visible pair
      showToast("Hint genutzt", `-${cost} Moves`);
      // Visual feedback placeholder (border blinken)
      let found = false;
      for(let r=0; r<rows; r++){
        if(found) break;
        for(let c=0; c<cols-1; c++){
          // Mockup hint logic: just blink random valid neighbor
          if(grid[r][c] && grid[r][c+1]){
             tileEls.get(grid[r][c].id).classList.add("pop");
             tileEls.get(grid[r][c+1].id).classList.add("pop");
             setTimeout(()=>{
               tileEls.get(grid[r][c].id).classList.remove("pop");
               tileEls.get(grid[r][c+1].id).classList.remove("pop");
             }, 500);
             found=true; break;
          }
        }
      }
    };

    /* --- UI UPDATES --- */
    function updateUI(){
      uiScore.textContent = score;
      uiMoves.textContent = moves;
      uiLevel.textContent = level;
      uiGoal.textContent = target;
      uiScore.style.transform = "scale(1.2)";
      setTimeout(()=>uiScore.style.transform="scale(1)", 150);
    }

    function showToast(msg, sub="", warn=false){
      const t = document.createElement("div");
      t.className = "toast";
      t.innerHTML = `<b style="color:${warn?'red':'#ff4fb9'}">${msg}</b>${sub?`<div>${sub}</div>`:''}`;
      document.getElementById("toast").appendChild(t);
      setTimeout(()=>t.remove(), 2500);
    }
    
    /* --- GREETING & NAME FILTER --- */
    const badWords = ["arsch", "idiot", "trottel"]; // Simple example list
    const whiteList = ["KOALAaufPILLEN"];

    document.getElementById("greetPlay").onclick = () => {
      let name = document.getElementById("playerNameInput").value.trim();
      if(!name) name = "Gast";
      
      // Filter logic
      const lower = name.toLowerCase();
      const isWhite = whiteList.some(w => w.toLowerCase() === lower);
      const isBad = badWords.some(w => lower.includes(w));

      if(isBad && !isWhite){
        alert("Dieser Name ist nicht erlaubt! üç≠");
        return;
      }

      currentPlayerName = name;
      document.getElementById("greetBack").style.display="none";
      restartGame();
    };

    /* --- DARK MODE --- */
    function toggleDark(force=null){
      const body = document.body;
      const isDark = force !== null ? force : !body.classList.contains("dark");
      
      if(isDark) body.classList.add("dark");
      else body.classList.remove("dark");
      
      document.getElementById("btnDark").classList.toggle("active", isDark);
      localStorage.setItem("luvvies_dark", isDark ? "1" : "0");
    }
    document.getElementById("btnDark").onclick = () => toggleDark();

    /* --- SUPABASE MOCK (Browser-Local Fallback) --- */
    let scores = [];
    function setupSupabase(){
      // Falls Supabase Key fehlt, nutzen wir lokales Array zur Demo
      scores = JSON.parse(localStorage.getItem("luvvies_scores") || "[]");
    }
    
    function postScore(){
       // In echter App hier supabase.insert()
       const n = document.getElementById("goNameInput").value || currentPlayerName;
       scores.push({ name: n, score: score, lvl: level });
       scores.sort((a,b) => b.score - a.score);
       scores = scores.slice(0, 10); // Top 10 keep
       localStorage.setItem("luvvies_scores", JSON.stringify(scores));
       refreshLeaderboard();
       document.getElementById("gameOverBack").style.display="none";
       showToast("Score gespeichert!");
    }
    document.getElementById("btnPostScore").onclick = postScore;

    function refreshLeaderboard(){
      const list = document.getElementById("lbList");
      list.innerHTML = "";
      scores.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = `lbItem rank${i+1}`;
        div.innerHTML = `<span>${i+1}. <b>${s.name}</b></span><span>${s.score}</span>`;
        list.appendChild(div);
      });
      if(scores.length===0) list.innerHTML = "<div style='padding:10px;opacity:0.6'>Noch keine Scores.</div>";
    }

    // Start
    init();

  </script>
</body>
</html>
