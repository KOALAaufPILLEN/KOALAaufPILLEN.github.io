<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Luvvies Crush</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      min-height: 100vh;
      overflow-x: hidden;
      background: linear-gradient(120deg,#ffe8ff,#e8f1ff,#fff6e8,#e8fff2);
      background-size: 600% 600%;
      animation: bgFade 18s ease-in-out infinite;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    @keyframes bgFade{
      0%,100%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
    }

    :root{
      --cell: 54px;
      --gap: 8px;
      --pad: 14px;
      --cardR: 18px;
      --shadow: 0 14px 26px rgba(0,0,0,.12);
      --stroke: rgba(17,13,26,.10);
      --glass: rgba(255,255,255,.55);
    }

    /* Layout */
    #page{
      width: min(980px, 96vw);
      margin: 12px auto 24px auto;
      padding: 10px;
      box-sizing: border-box;
    }
    .topRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .panel{
      background: rgba(255,255,255,.62);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: 18px;
      padding: 10px 12px;
      backdrop-filter: blur(8px);
    }
    .panel h3{
      margin:0 0 6px 0;
      font-size: 14px;
      opacity: .8;
    }

    .Btn {
      position: relative;
      width: 150px;
      height: 55px;
      border-radius: 45px;
      border: none;
      background-color: rgb(151, 95, 255);
      color: white;
      box-shadow: 0px 10px 10px rgb(210, 187, 253) inset,
      0px 5px 10px rgba(5, 5, 5, 0.212),
      0px -10px 10px rgb(124, 54, 255) inset;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding:0 18px;
      font-weight: 700;
      letter-spacing: .2px;
      user-select:none;
    }
    .Btn::before {
      width: 70%;
      height: 2px;
      position: absolute;
      background-color: rgba(250, 250, 250, 0.678);
      content: "";
      filter: blur(1px);
      top: 7px;
      border-radius: 50%;
    }
    .Btn::after {
      width: 70%;
      height: 2px;
      position: absolute;
      background-color: rgba(250, 250, 250, 0.137);
      content: "";
      filter: blur(1px);
      bottom: 7px;
      border-radius: 50%;
    }
    .Btn:hover { animation: jello-horizontal 0.9s both; }
    @keyframes jello-horizontal {
      0% { transform: scale3d(1, 1, 1); }
      30% { transform: scale3d(1.25, 0.75, 1); }
      40% { transform: scale3d(0.75, 1.25, 1); }
      50% { transform: scale3d(1.15, 0.85, 1); }
      65% { transform: scale3d(0.95, 1.05, 1); }
      75% { transform: scale3d(1.05, 0.95, 1); }
      100% { transform: scale3d(1, 1, 1); }
    }

    /* Board */
    .playArea{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:center;
      flex-wrap: wrap;
    }
    #boardWrap{
      position: relative;
      background: rgba(255,255,255,.40);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: var(--pad);
      overflow: hidden;
    }
    #board{
      position: relative;
      width: calc(var(--cols) * (var(--cell) + var(--gap)) - var(--gap) + var(--pad)*2);
      height: calc(var(--rows) * (var(--cell) + var(--gap)) - var(--gap) + var(--pad)*2);
      border-radius: 18px;
    }
    #fxLayer, #warnLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    #warnLayer{ z-index:18; }
    #fxLayer{ z-index:40; }

    .tile{
      position:absolute;
      width: var(--cell);
      height: var(--cell);
      transform: translate(var(--x), var(--y));
      transition: transform .22s cubic-bezier(.2,.9,.2,1);
      z-index: 20;
    }
    .tile .plate{
      width:100%;
      height:100%;
      border-radius: var(--cardR);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.75), rgba(255,255,255,.25)),
                  linear-gradient(140deg,var(--p1),var(--p2));
      border:1px solid rgba(255,255,255,.40);
      box-shadow: 0 10px 18px rgba(0,0,0,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .tile img{
      width: 92%;
      height: 92%;
      object-fit: contain;
      filter: drop-shadow(0 6px 8px rgba(0,0,0,.18));
      transform: translateZ(0);
    }

    .tile.pop .plate{ animation: popOut .45s ease forwards; }
    @keyframes popOut{ 0%{transform:scale(1);} 60%{transform:scale(1.12);} 100%{transform:scale(.0);opacity:0;} }

    .tile.land .plate{ animation: landBounce .55s cubic-bezier(.2,1.4,.3,1) both; }
    @keyframes landBounce{
      0%{transform: translateY(-10px) scale(.96);}
      60%{transform: translateY(3px) scale(1.02);}
      100%{transform: translateY(0px) scale(1);}
    }

    /* Warning cells for incoming Zilla */
    .warnCell{
      position:absolute;
      width: var(--cell);
      height: var(--cell);
      transform: translate(var(--x), var(--y));
      border-radius: 18px;
      background: rgba(255, 69, 93, .18);
      border: 2px solid rgba(255, 99, 124, .55);
      box-shadow: 0 0 18px rgba(255, 89, 120, .22);
      animation: warnPulse 1.35s ease-in-out infinite;
    }
    .warnCell.urgent{
      animation-duration: .9s;
      background: rgba(255, 69, 93, .26);
    }
    @keyframes warnPulse{
      0%,100%{ transform: translate(var(--x), var(--y)) scale(1); filter:saturate(1); }
      50%{ transform: translate(var(--x), var(--y)) scale(1.06); filter:saturate(1.35); }
    }

    /* Big boss tile */
    .tile.bigZilla{
      width: calc(var(--cell)*3 + var(--gap)*2);
      height: calc(var(--cell)*3 + var(--gap)*2);
      z-index: 55;
    }
    .tile.bigZilla .plate{
      border-radius: 30px;
      box-shadow: 0 14px 26px rgba(0,0,0,.18);
    }
    .tile.bigZilla.wiggle .plate{
      animation: zillaWiggle 1.35s ease-in-out infinite;
    }
    @keyframes zillaWiggle{
      0%,100%{ transform: rotate(0deg) scale(1); }
      25%{ transform: rotate(-1.2deg) scale(1.01); }
      50%{ transform: rotate(1.2deg) scale(1.01); }
      75%{ transform: rotate(-.7deg) scale(1.005); }
    }

    .mellowHp{
      position:absolute;
      right:10px;
      bottom:10px;
      font-weight:900;
      color:#fff;
      text-shadow: 0 3px 8px rgba(0,0,0,.35);
      font-size: 18px;
      animation: hpGlow 2.2s ease-in-out infinite;
    }
    @keyframes hpGlow{ 0%,100%{filter:brightness(1);} 50%{filter:brightness(1.35);} }

    /* Mobile scaling */
    @media (max-width: 520px){
      :root{ --cell: 46px; --gap: 7px; --pad: 12px; }
      #page{ width: 98vw; }
      .Btn{ width: 138px; height: 52px; }
    }

    /* Simple toasts */
    #toast{
      position: fixed;
      left: 16px;
      bottom: 16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index: 9999;
      pointer-events:none;
    }
    .toast{
      background: rgba(20,10,60,.82);
      color:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.20);
      width: min(320px, 86vw);
      animation: toastIn .35s ease both;
    }
    @keyframes toastIn{ from{opacity:0; transform:translateY(10px) scale(.98);} to{opacity:1; transform:translateY(0) scale(1);} }
    .toast b{display:block; margin-bottom:2px;}

    /* Guide modal */
    #modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9998;
    }
    #modal{
      width: min(820px, 94vw);
      max-height: 86vh;
      overflow:auto;
      background: rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 14px 16px;
      box-shadow: 0 18px 50px rgba(0,0,0,.30);
      color:#111;
    }
    #modal h2{ margin: 6px 0 8px 0; }
    .guideList{ margin: 0; padding-left: 18px; }
    .guideList li{ margin: 8px 0; }
    .mono{font-weight:900; color:#7a2cff;}
    .exRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .exCard{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:16px; background: rgba(151,95,255,.10); border:1px solid rgba(151,95,255,.25); }
    .exCard img{ width:48px; height:48px; object-fit:contain; }

  </style>
</head>
<body>

  <div id="page">

    <div class="topRow">
      <div class="panel">
        <h3>Schwierigkeit</h3>
        <label><input type="radio" name="diff" id="d_easy" checked> Easy</label>
        <label><input type="radio" name="diff" id="d_normal"> Normal</label>
        <label><input type="radio" name="diff" id="d_hard"> Hard</label>
        <label><input type="radio" name="diff" id="d_shock"> Zuckerschock</label>
      </div>

      <div class="panel">
        <h3>Aktionen</h3>
        <button class="Btn" id="btnGuide">Anleitung</button>
        <button class="Btn" id="btnNew">Neues Spiel</button>
      </div>

      <div class="panel">
        <h3>Status</h3>
        <div><b id="uiLevel">Level 1</b></div>
        <div>Ziel: <b id="uiGoal">0</b></div>
        <div>Score: <b id="uiScore">0</b></div>
        <div>Moves: <b id="uiMoves">0</b></div>
      </div>
    </div>

    <div class="playArea">
      <div id="boardWrap">
        <div id="board"></div>
        <div id="warnLayer"></div>
        <div id="fxLayer"></div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <h3>Quick Tips</h3>
      <div id="quickTips"></div>
    </div>

  </div>

  <!-- Toasts -->
  <div id="toast"></div>

  <!-- Guide Modal -->
  <div id="modalMask">
    <div id="modal">
      <h2>üç¨ Luvvies Crush ‚Äì Anleitung</h2>

      <ul class="guideList">
        <li>Matche <b>3 gleiche</b>, um sie zu clearen (Candy-Style Bounce + Glitter).</li>
        <li><b>4er Match</b> ‚áí Sourworm (Reihe/Spalte)</li>
        <li><b>5er Match</b> ‚áí Citrussy (Radius 3)</li>
        <li><b>T/L Match</b> ‚áí Koala (Magie)</li>
        <li><b>2√ó Sleepy + 1√ó Mondlie</b> ‚áí Shuffle 4√ó4 (nur Bereich, nicht Board)</li>
        <li><b>Falscher Swap</b> kostet <b>3 Moves</b> (au√üer Powerup-Combos)</li>
        <li><b>Keine Z√ºge m√∂glich</b> ‚áí Auto-Shuffle, ‚àí3 Moves</li>
        <li><b>MellowZilla</b> (ab Level 20, 40, 60‚Ä¶): <span class="mono">2 Z√ºge vorher</span> werden die <span class="mono">3√ó3</span> Felder in der Mitte rot markiert. Nach 2 Z√ºgen wird der Bereich gel√∂scht und Zilla spawnt dort. <b>Clears neben Zilla</b> ziehen ihm HP ab. Bei 0 HP verschwindet er und du bekommst <b>+20.000 Punkte</b>.</li>
      </ul>

      <div class="exRow">
        <div class="exCard"><img id="exZilla"><b>MellowZilla</b> ‚Äì Boss (3√ó3)</div>
        <div class="exCard"><img id="exSleepy"><b>Sleepy</b> ‚Äì normal</div>
        <div class="exCard"><img id="exMond"><b>Mondlie</b> ‚Äì normal</div>
      </div>

      <div style="margin-top:12px; display:flex; justify-content:flex-end;">
        <button class="Btn" id="btnCloseGuide">OK ‚ú®</button>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * Difficulty (FIXED)
     **********************/
    const DIFFS = {
      easy:   { key:"easy",   name:"Easy",         rows:10, cols:10, scoreMult:0.85, baseMoves:28, movesPerLevel:2, baseTarget:3500, targetGrow:0.18, lovelieChance:0.006, mystChance:0.010 },
      normal: { key:"normal", name:"Normal",       rows: 9, cols: 9, scoreMult:1.00, baseMoves:24, movesPerLevel:2, baseTarget:4200, targetGrow:0.20, lovelieChance:0.005, mystChance:0.009 },
      hard:   { key:"hard",   name:"Hard",         rows: 9, cols: 8, scoreMult:1.25, baseMoves:20, movesPerLevel:1, baseTarget:5000, targetGrow:0.22, lovelieChance:0.004, mystChance:0.008 },
      shock:  { key:"shock",  name:"Zuckerschock", rows: 8, cols: 8, scoreMult:1.55, baseMoves:18, movesPerLevel:1, baseTarget:6500, targetGrow:0.24, lovelieChance:0.003, mystChance:0.007 }
    };
    let diff = DIFFS.easy;

    /**********************
     * Images
     **********************/
    const IMG = {
      sleepy:   "https://static.wixstatic.com/media/d05122_cfd779a0aad04c72bd08efbc0f363f53~mv2.png",
      mond:     "https://static.wixstatic.com/media/d05122_aea344c0fd954194af2855eea745febf~mv2.png",
      mellowzilla:"https://static.wixstatic.com/media/d05122_24fbaf9c9b0247cdab1db147594ce8a6~mv2.png",
    };

    // Guide examples
    document.getElementById("exZilla").src = IMG.mellowzilla;
    document.getElementById("exSleepy").src = IMG.sleepy;
    document.getElementById("exMond").src = IMG.mond;

    /**********************
     * UI
     **********************/
    const ui = {
      level: document.getElementById("uiLevel"),
      goal:  document.getElementById("uiGoal"),
      score: document.getElementById("uiScore"),
      moves: document.getElementById("uiMoves"),
      tips:  document.getElementById("quickTips"),
      board: document.getElementById("board"),
      warn:  document.getElementById("warnLayer"),
      fx:    document.getElementById("fxLayer"),
    };

    /**********************
     * Toast
     **********************/
    function toast(title, msg, ms=3200){
      const box=document.createElement("div");
      box.className="toast";
      box.innerHTML = `<b>${title}</b><div>${msg}</div>`;
      document.getElementById("toast").appendChild(box);
      setTimeout(()=>{ box.style.opacity="0"; box.style.transition="opacity .35s"; }, ms-380);
      setTimeout(()=>{ box.remove(); }, ms);
    }

    /**********************
     * Game State
     **********************/
    let rows=10, cols=10;
    let grid=[];
    let tileEls = new Map();
    let level=1, totalScore=0, levelScore=0, target=0, moves=0;

    let CELL=54, GAP=8, PAD=14;

    // MellowZilla state
    let zilla=null;             // active boss
    let zillaIncoming=null;     // {topR, topC, turns}
    let zillaPendingSpawn=false;

    function setTileXY(el, r, c){
      const x = c*(CELL+GAP) + PAD;
      const y = r*(CELL+GAP) + PAD;
      el.style.setProperty("--x", x+"px");
      el.style.setProperty("--y", y+"px");
    }
    function inBounds(r,c){ return r>=0 && c>=0 && r<rows && c<cols; }

    function layoutBoard(){
      rows=diff.rows; cols=diff.cols;
      document.documentElement.style.setProperty("--rows", rows);
      document.documentElement.style.setProperty("--cols", cols);

      const wrap=document.getElementById("boardWrap");
      const page=document.getElementById("page");

      // auto scale on desktop/mobile
      const maxW = Math.min(page.clientWidth-24, window.innerWidth-24);
      const baseW = cols*(CELL+GAP)-GAP + PAD*2;
      const scale = Math.min(1, maxW / baseW);
      wrap.style.transform = `scale(${scale})`;
      wrap.style.transformOrigin="top center";
    }

    function scorePerTile(){ return Math.round(60 * diff.scoreMult); }
    function calcTarget(lv){ return Math.round(diff.baseTarget*(1+(lv-1)*diff.targetGrow)); }
    function calcMoves(lv){
      const m = diff.baseMoves+(lv-1)*diff.movesPerLevel;
      return Math.min(m, diff.key==="easy"?70: diff.key==="normal"?60: diff.key==="hard"?50:45);
    }

    function makeId(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
    function makeTile(r,c,type){
      const id=makeId();
      return {id,r,c,type,hp:0,big:false};
    }

    function createTileEl(tile){
      const el=document.createElement("div");
      el.className="tile";
      el.dataset.id=tile.id;

      if(tile.type==="zilla_part"){
        el.style.display="none";
        return el;
      }

      // boss tile
      if(tile.type==="zilla:P"){
        el.classList.add("bigZilla","wiggle");
      }

      const plate=document.createElement("div");
      plate.className="plate";

      // simple palette
      const pal = tile.type==="zilla:P"
        ? ["#ff3e6c","#ffce5b"]
        : ["#8fe0ff","#ff73d4"];

      plate.style.setProperty("--p1", pal[0]);
      plate.style.setProperty("--p2", pal[1]);

      const img=document.createElement("img");
      img.src = tile.type==="zilla:P" ? IMG.mellowzilla : IMG.sleepy;
      plate.appendChild(img);

      el.appendChild(plate);

      if(tile.type==="zilla:P"){
        const hp=document.createElement("div");
        hp.className="mellowHp";
        hp.textContent=tile.hp;
        el.appendChild(hp);
      }

      setTileXY(el, tile.r, tile.c);
      return el;
    }

    function initBoard(){
      rows=diff.rows; cols=diff.cols;
      grid = Array.from({length:rows},(_,r)=>Array.from({length:cols},(_,c)=>null));
      tileEls.clear();
      ui.board.innerHTML="";
      ui.warn.innerHTML="";
      ui.fx.innerHTML="";
      zilla=null; zillaIncoming=null; zillaPendingSpawn=false;

      // Fill dummy tiles (Sleepy only in this minimal snippet)
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const t=makeTile(r,c,"sleepy:A");
          grid[r][c]=t;
          const el=createTileEl(t);
          tileEls.set(t.id,el);
          ui.board.appendChild(el);
        }
      }

      target=calcTarget(level);
      moves=calcMoves(level);

      ui.tips.innerHTML = `
        ‚Ä¢ <b>Ab Level 20</b>: MellowZilla k√ºndigt ein <b>3√ó3 Feld rot</b> an (2 Z√ºge) und l√∂scht es dann.<br>
        ‚Ä¢ Danach spawnt er dort und blockiert 3√ó3 ‚Äì Clears neben ihm ziehen HP ab.<br>
      `;

      updateUI();
      layoutBoard();
    }

    function updateUI(){
      ui.level.textContent = "Level "+level;
      ui.goal.textContent  = target.toLocaleString("de-DE");
      ui.score.textContent = totalScore.toLocaleString("de-DE");
      ui.moves.textContent = moves;
    }

    /**********************
     * Zilla warning + spawn
     **********************/
    function renderZillaWarn(){
      ui.warn.innerHTML="";
      if(!zillaIncoming) return;
      const {topR,topC,turns}=zillaIncoming;
      for(let r=topR;r<topR+3;r++){
        for(let c=topC;c<topC+3;c++){
          if(!inBounds(r,c)) continue;
          const d=document.createElement("div");
          d.className="warnCell"+(turns<=1?" urgent":"");
          setTileXY(d,r,c);
          ui.warn.appendChild(d);
        }
      }
    }

    function scheduleZillaIfNeeded(){
      if(level<20) return;
      if(level%20!==0) return;
      if(zilla || zillaIncoming) return;

      const topR=Math.max(0,Math.floor((rows-3)/2));
      const topC=Math.max(0,Math.floor((cols-3)/2));
      zillaIncoming={topR,topC,turns:2};

      toast("‚ö†Ô∏è MellowZilla kommt!","In 2 Z√ºgen wird das rot markierte 3√ó3 Feld gel√∂scht‚Ä¶",4200);
      renderZillaWarn();
    }

    function tickZillaTurn(){
      if(!zillaIncoming) return;
      zillaIncoming.turns=Math.max(0,zillaIncoming.turns-1);
      renderZillaWarn();
      if(zillaIncoming.turns===0) zillaPendingSpawn=true;
    }

    function forceClearArea3x3(topR,topC){
      for(let r=topR;r<topR+3;r++){
        for(let c=topC;c<topC+3;c++){
          if(!inBounds(r,c)) continue;
          const t=grid[r][c];
          if(!t) continue;
          const el=tileEls.get(t.id);
          if(el){
            el.classList.add("pop");
            setTimeout(()=>{ el.remove(); },420);
          }
          tileEls.delete(t.id);
          grid[r][c]=null;
        }
      }
    }

    function spawnZillaNow(){
      if(!zillaIncoming) return;
      const {topR,topC}=zillaIncoming;
      zillaIncoming=null;
      zillaPendingSpawn=false;
      ui.warn.innerHTML="";

      forceClearArea3x3(topR,topC);

      const boss=makeTile(topR,topC,"zilla:P");
      boss.big=true;
      boss.hp = diff.key==="easy"?12: diff.key==="normal"?16: diff.key==="hard"?20:24;

      grid[topR][topC]=boss;

      for(let r=topR;r<topR+3;r++){
        for(let c=topC;c<topC+3;c++){
          if(r===topR && c===topC) continue;
          if(!inBounds(r,c)) continue;
          const part=makeTile(r,c,"zilla_part");
          part.partOf=boss.id;
          grid[r][c]=part;
        }
      }

      const el=createTileEl(boss);
      tileEls.set(boss.id,el);
      ui.board.appendChild(el);

      zilla={id:boss.id, topR, topC, hp:boss.hp, maxHp:boss.hp};
      toast("ü¶ñ MellowZilla!","Besiege ihn! Clears neben ihm ziehen HP ab. +20.000 Punkte!",5200);
      updateUI();
    }

    /**********************
     * Buttons + demo ‚Äúturn‚Äù
     **********************/
    document.getElementById("btnGuide").onclick=()=>{
      document.getElementById("modalMask").style.display="flex";
    };
    document.getElementById("btnCloseGuide").onclick=()=>{
      document.getElementById("modalMask").style.display="none";
    };
    document.getElementById("btnNew").onclick=()=>{
      level=1; totalScore=0; levelScore=0;
      initBoard();
      toast("Neues Spiel ‚ú®", diff.name+" gestartet!",2600);
    };

    // Difficulty radios
    document.getElementById("d_easy").onchange=()=>{ diff=DIFFS.easy; initBoard(); };
    document.getElementById("d_normal").onchange=()=>{ diff=DIFFS.normal; initBoard(); };
    document.getElementById("d_hard").onchange=()=>{ diff=DIFFS.hard; initBoard(); };
    document.getElementById("d_shock").onchange=()=>{ diff=DIFFS.shock; initBoard(); };

    // Demo: each click on board counts as a turn (for showing Zilla warning/spawn)
    ui.board.addEventListener("click", ()=>{
      if(zillaPendingSpawn){ spawnZillaNow(); return; }
      moves=Math.max(0,moves-1);
      tickZillaTurn();
      updateUI();
    });

    window.addEventListener("resize", layoutBoard);

    // start
    initBoard();
    // for testing: set level 20 to see it instantly
    // level=20; scheduleZillaIfNeeded();
  </script>
</body>
</html>
